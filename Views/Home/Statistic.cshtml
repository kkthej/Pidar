@{
    ViewData["Title"] = "Statistic";
}
<h2 class="text-center mb-4">Statistics</h2>


@{
    var enabled = (ViewData["TrafficConfigured"] as bool?) ?? false;
    var hasData = (ViewData["TrafficHasData"] as bool?) ?? false;
}


<!-- ========================================================= -->
<!-- TRAFFIC ANALYTICS (PUBLIC, GDPR-SAFE) -->
<!-- ========================================================= -->
@{
    // These should be set by your controller from the Matomo service (last30)
    var enabled = (ViewData["TrafficEnabled"] as bool?) ?? false;

    var visitsLast30 = (ViewData["VisitsLast30"] as int?) ?? 0;
    var uniquesLast30 = (ViewData["UniquesLast30"] as int?) ?? 0;

    // "Has data" should be based on the last-30-days window, not "today"
    var hasData = enabled && (visitsLast30 > 0 || uniquesLast30 > 0);
}

@if (!enabled)
{
    <div class="alert alert-info shadow-sm mb-4">
        <strong>Traffic analytics not enabled yet.</strong><br />
        Aggregated and anonymized usage statistics will appear here once analytics is configured.
    </div>
}
else if (!hasData)
{
    <div class="alert alert-secondary shadow-sm mb-4">
        <strong>Traffic analytics is enabled.</strong><br />
        No traffic recorded in the last 30 days. Visit a few pages and refresh this section.
    </div>
}
else
{
    <div class="row mb-4">

        <div class="col-md-3">
            <div class="card shadow h-100">
                <div class="card-body">
                    <div class="text-muted">Visits (last 30 days)</div>
                    <div class="display-6 fw-bold">@visitsLast30</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow h-100">
                <div class="card-body">
                    <div class="text-muted">Unique visitors (last 30 days)</div>
                    <div class="display-6 fw-bold">@uniquesLast30</div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">Visits per day (last 30 days)</h4>
                </div>
                <div class="card-body">
                    <div style="position: relative; height:250px;">
                        <canvas id="visitsPerDayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="row mb-5">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Top countries (last 30 days)</h4>
                </div>
                <div class="card-body">
                    <div style="position: relative; height:300px;">
                        <canvas id="topCountriesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
}


<div class="container mt-4">

    <!-- Row 1 -->
    <div class="row mb-4">

        <!-- Imaging Modality -->
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Imaging Modality Distribution</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="modalityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Imaging Facility Countries -->
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Imaging Facility Countries</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="countryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Row 2 -->
    <div class="row mb-4">

        <!-- Disease Models -->
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">Disease Models</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="diseaseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Organs / Tissues -->
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">Organs / Tissues</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="organChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    @* <!-- Row 2.5 --> *@
    @* <div class="row mb-4"> *@

    @*     <!-- Status --> *@
    @*     <div class="col-md-6"> *@
    @*         <div class="card shadow h-100"> *@
    @*             <div class="card-header bg-info text-white"> *@
    @*                 <h4 class="mb-0">Study Status Distribution</h4> *@
    @*             </div> *@
    @*             <div class="card-body"> *@
    @*                 <div class="chart-container" style="position: relative; height:400px;"> *@
    @*                     <canvas id="statusChart"></canvas> *@
    @*                 </div> *@
    @*             </div> *@
    @*         </div> *@
    @*     </div> *@

    @* </div> *@

    <!-- Row 3 -->
    <div class="row mb-4">

        <!-- Yearly uploads -->
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h4 class="mb-0">Datasets Uploaded by Year</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>



@section Scripts {

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            /* ============================================================
   TRAFFIC ANALYTICS (optional)
   ============================================================ */
const trafficConfigured =
    '@(((bool?)ViewData["TrafficConfigured"]) ?? false)'.toLowerCase() === 'true';

if (trafficConfigured) {
    const visitsPerDay = parse('@Html.Raw(ViewData["VisitsPerDayLast30"] ?? "[]")');
    const topCountries = parse('@Html.Raw(ViewData["TopCountriesLast30"] ?? "[]")');

    const vpCanvas = document.getElementById('visitsPerDayChart');
    if (vpCanvas && visitsPerDay.length) {
        new Chart(vpCanvas, {
            type: 'line',
            data: {
                labels: visitsPerDay.map(x => x.Date),
                datasets: [{
                    data: visitsPerDay.map(x => x.Visits),
                    borderWidth: 2,
                    tension: 0.25
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    const tcCanvas = document.getElementById('topCountriesChart');
    if (tcCanvas && topCountries.length) {
        new Chart(tcCanvas, {
            type: 'bar',
            data: {
                labels: topCountries.map(x => x.Country),
                datasets: [{
                    data: topCountries.map(x => x.Visits),
                    borderWidth: 1
                }]
            },
            options: barOptions("Top countries (last 30 days)", true)
        });
    }
}



            /* ============================================================
               COLOR PALETTE
               ============================================================ */
            const colors = [
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(199, 199, 199, 0.7)',
                'rgba(83, 102, 255, 0.7)',
                'rgba(40, 167, 69, 0.7)',
                'rgba(108, 117, 125, 0.7)'
            ];
            const borderColors = colors.map(c => c.replace("0.7", "1"));


            /* ============================================================
               SAFE JSON PARSER
               ============================================================ */
            function parse(json) {
                try { return json ? JSON.parse(json) : []; }
                catch { return []; }
            }


            /* ============================================================
               REUSABLE OPTIONS HELPERS
               ============================================================ */

            function legendWithCounts(title, isDonut = false) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                generateLabels(chart) {
                                    const ds = chart.data.datasets[0];
                                    const total = ds.data.reduce((a, b) => a + b, 0);

                                    const items = chart.data.labels.map((lbl, i) => ({
                                        text: `${lbl} (${ds.data[i]})`,
                                        fillStyle: ds.backgroundColor[i],
                                        hidden: !chart.getDataVisibility(i),
                                        index: i
                                    }));

                                    // Add total (no color box)
                                    items.push({
                                        text: `Total: ${total}`,
                                        fillStyle: 'transparent',
                                        strokeStyle: 'transparent',
                                        hidden: true
                                    });

                                    return items;
                                },
                                filter(item) {
                                    return !item.text.startsWith("Total:");
                                },
                                boxWidth: 20,
                                boxHeight: 12
                            }
                        },
                        title: {
                            display: true,
                            text: title,
                            font: { size: 16 }
                        }
                    },
                    cutout: isDonut ? "70%" : undefined
                };
            }

            function barOptions(title, horizontal = false) {
                return {
                    indexAxis: horizontal ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: title, font: { size: 16 } }
                    },
                    scales: {
                        x: horizontal ? {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Datasets' }
                        } : {},
                        y: !horizontal ? {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Datasets' }
                        } : {}
                    }
                };
            }

            function lineOptions(title) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: title, font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Datasets' }},
                        x: { title: { display: true, text: 'Year' }}
                    }
                };
            }


            /* ============================================================
               FETCH DATA FROM ViewData
               ============================================================ */

            const modality = parse('@Html.Raw(ViewData["ModalityDistribution"])');
            const countries = parse('@Html.Raw(ViewData["CountryDistribution"])');
            const disease = parse('@Html.Raw(ViewData["DiseaseModelDistribution"])');
            const organs = parse('@Html.Raw(ViewData["OrganDistribution"])');
            const status = parse('@Html.Raw(ViewData["StatusDistribution"])');
            const yearly = parse('@Html.Raw(ViewData["YearlyUploads"])');


            /* ============================================================
               RENDER CHARTS
               ============================================================ */

            new Chart(document.getElementById('modalityChart'), {
                type: 'doughnut',
                data: {
                    labels: modality.map(x => x.Label),
                    datasets: [{
                        data: modality.map(x => x.Count),
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: legendWithCounts("Distribution across imaging modalities", true)
            });

            new Chart(document.getElementById('countryChart'), {
                type: 'bar',
                data: {
                    labels: countries.map(x => x.Country),
                    datasets: [{
                        data: countries.map(x => x.Count),
                        backgroundColor: colors,
                        borderColor: borderColors
                    }]
                },
                options: barOptions("Countries where imaging was performed")
            });

            new Chart(document.getElementById('diseaseChart'), {
                type: 'bar',
                data: {
                    labels: disease.map(x => x.Disease),
                    datasets: [{
                        data: disease.map(x => x.Count),
                        backgroundColor: colors,
                        borderColor: borderColors
                    }]
                },
                options: barOptions("Most studied disease models", true)
            });

            new Chart(document.getElementById('organChart'), {
                type: 'pie',
                data: {
                    labels: organs.map(x => x.Organ),
                    datasets: [{
                        data: organs.map(x => x.Count),
                        backgroundColor: colors,
                        borderColor: borderColors
                    }]
                },
                options: legendWithCounts("Most studied organs/tissues")
            });

            // new Chart(document.getElementById('statusChart'), {
            //     type: 'pie',
            //     data: {
            //         labels: status.map(x => x.Status),
            //         datasets: [{
            //             data: status.map(x => x.Count),
            //             backgroundColor: colors,
            //             borderColor: borderColors
            //         }]
            //     },
            //     options: legendWithCounts("Distribution of study statuses")
            // });

            new Chart(document.getElementById('yearlyChart'), {
                type: 'line',
                data: {
                    labels: yearly.map(x => x.Year),
                    datasets: [{
                        data: yearly.map(x => x.Count),
                        backgroundColor: colors[0],
                        borderColor: colors[0].replace("0.7", "1"),
                        borderWidth: 2,
                        tension: 0.2
                    }]
                },
                options: lineOptions("Datasets uploaded by year")
            });

        });
    </script>

}
