@model Pidar.Models.ViewModels.DatasetCreateViewModel
@using Pidar.Helpers

@{
    ViewData["Title"] = "Edit Dataset";

    var colorClasses = new[] { "primary", "success", "info", "warning", "danger", "secondary" };
    var colorIndex = 0;

    bool IsLong(string field)
    {
        return field.Contains("Background") ||
               field.Contains("Description") ||
               field.Contains("Procedure") ||
               field.Contains("Details") ||
               field.Contains("Protocol") ||
               field.Contains("Notes") ||
               field.Contains("Justification");
    }

    string PrettyLabel(string raw)
    {
        raw = raw.Replace("/", " ");

        string formatted = System.Text.RegularExpressions.Regex
            .Replace(raw, @"(?<=[a-z0-9])(?=[A-Z][a-z])", " ")
            .Trim();

        return string.IsNullOrEmpty(formatted)
            ? raw
            : char.ToUpper(formatted[0]) + formatted.Substring(1);
    }

    // -------------------------------
    // CATEGORY DEFINITIONS
    // -------------------------------
    var categories = CategoryProvider.GetCategories();
}

<h2 class="text-center mb-4">@ViewData["Title"]</h2>

<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()

    <!-- Hidden PK -->
    <input type="hidden" name="Dataset.DatasetId" value="@Model.Dataset.DatasetId" />

    <!-- CATEGORY RENDERING -->
    @foreach (var category in categories)
    {
        var color = colorClasses[colorIndex % colorClasses.Length];
        colorIndex++;

        <div class="card mb-4 shadow-sm border-@color">
            <div class="card-header bg-@color text-white fw-bold">
                @category.Key
            </div>

            <div class="card-body">

                @foreach (var field in category.Value)
                {
                    string property = field.Split('.')[1];
                    string label = PrettyLabel(property);
                    string? value = ObjectHelper.GetValue(Model, field);

                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <label class="form-label">@label</label>
                        </div>
                        <div class="col-sm-8">

                            @if (IsLong(property))
                            {
                                <textarea class="form-control"
                                          name="@field"
                                          rows="3">@value</textarea>
                            }
                            else
                            {
                                <input class="form-control"
                                       name="@field"
                                       value="@value" />
                            }

                        </div>
                    </div>
                }

            </div>
        </div>
    }

    <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary px-4">Save</button>
        <a asp-action="Index" class="btn btn-outline-secondary px-4">Cancel</a>
    </div>

</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}