@model Pidar.Models.Dataset
@using Microsoft.AspNetCore.Html

@{
    ViewData["Title"] = "Delete Dataset";
   
}

@functions {
    public IHtmlContent FormatLabel(string raw)
    {
        if (String.IsNullOrWhiteSpace(raw)) return HtmlString.Empty;

        var clean = raw.Replace("/", " ");

        var formatted = System.Text.RegularExpressions.Regex.Replace(
            clean,
            @"(?<=[a-z0-9])(?=[A-Z][a-z])",
            " "
        ).Trim();

        if (formatted.Length > 0)
            formatted = Char.ToUpper(formatted[0]) + formatted[1..];

        return new HtmlString(System.Net.WebUtility.HtmlEncode(formatted));
    }

    public IHtmlContent FormatValue(object? value)
    {
        var str = value?.ToString()?.Trim();
        if (String.IsNullOrWhiteSpace(str))
            return HtmlString.Empty;

        if (Uri.TryCreate(str, UriKind.Absolute, out var uri))
        {
            if (uri.Scheme == Uri.UriSchemeMailto || str.Contains("@"))
                return new HtmlString($"<a href=\"mailto:{str}\">{str}</a>");

            return new HtmlString($"<a href=\"{str}\" target=\"_blank\">{str}</a>");
        }

        if (str.Contains("@") && str.Contains("."))
            return new HtmlString($"<a href=\"mailto:{str}\">{str}</a>");

        str = str.Replace("/", " ");

        var formatted = System.Text.RegularExpressions.Regex.Replace(
            str,
            @"(?<=[a-z0-9])(?=[A-Z][a-z])",
            " "
        ).Trim();

        if (formatted.Length > 0)
            formatted = Char.ToUpper(formatted[0]) + formatted[1..];

        return new HtmlString(System.Net.WebUtility.HtmlEncode(formatted));
    }

    public object? GetNested(object? root, string path)
    {
        if (root == null || String.IsNullOrWhiteSpace(path)) return null;

        object? current = root;
        foreach (var part in path.Split('.'))
        {
            if (current == null) return null;

            var prop = current.GetType().GetProperty(part);
            if (prop == null) return null;

            current = prop.GetValue(current);
        }
        return current;
    }
}

<h2 class="text-center text-danger mb-4">Delete Dataset</h2>

<h4 class="text-center mb-3">
    Are you sure you want to permanently delete this dataset?
</h4>

<div class="alert alert-danger text-center">
    <strong>This action cannot be undone.</strong>
</div>

<hr />

<!-- ======================
     CATEGORY DEFINITIONS
     ====================== -->
@{
    var categories = CategoryProvider.GetCategories();
}

<!-- RENDER SUMMARY TABLES -->
<div class="container mb-4">

    @foreach (var category in categories)
    {
        bool hasContent = category.Value.Any(path =>
        {
            var val = GetNested(Model, path);
            return val != null && !String.IsNullOrWhiteSpace(val.ToString());
        });

        if (!hasContent) continue;

        var color = CategoryProvider.GetColor(category.Key);


        <div class="card mb-4 border-@color shadow-sm">
            <div class="card-header bg-@color text-white fw-bold text-center">
                @category.Key
            </div>

            <div class="card-body p-0">
                <table class="table table-striped mb-0">
                    <tbody>
                        @foreach (var path in category.Value)
                        {
                            var value = GetNested(Model, path);
                            if (value == null || String.IsNullOrWhiteSpace(value.ToString()))
                                continue;

                            <tr>
                                <th class="bg-light text-center align-middle" style="width:30%">
                                    @FormatLabel(path.Split('.').Last())
                                </th>
                                <td style="width:70%">@FormatValue(value)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<!-- DELETE CONFIRM BUTTON -->
<form asp-action="Delete" method="post" class="text-center">
    <input type="hidden" asp-for="DatasetId" />
    <button type="submit" class="btn btn-danger btn-lg px-5">Delete</button>
    <a asp-action="Index" class="btn btn-outline-secondary btn-lg px-5 ms-3">Cancel</a>
</form>
