@model PaginatedList<Pidar.Models.Dataset>
@using Microsoft.AspNetCore.Identity
@using Pidar.Areas.Identity.Data
@inject SignInManager<PidarUser> SignInManager
@inject UserManager<PidarUser> UserManager

@{
    ViewData["Title"] = "PIDAR – Datasets";
}

@functions {
    // UNIVERSAL SAFE NESTED PROPERTY GETTER
    public static object? GetNestedSafe(object? obj, string path)
    {
        if (obj == null || String.IsNullOrWhiteSpace(path))
            return null;

        var parts = path.Split('.');
        object? curr = obj;

        foreach (var p in parts)
        {
            if (curr == null) return null;

            var prop = curr.GetType().GetProperty(p);
            if (prop == null) return null;

            curr = prop.GetValue(curr);
        }

        return curr;
    }
}

<div id="sfondo" class="d-flex justify-content-center align-items-start">
    <img src="/images/sfondo.png" class="img-fluid" alt="Background" style="padding-bottom:20px;">
</div>

<h3 class="text-center mb-4">
    The Preclinical Image DAtaset Repository (PIDAR) is a public repository of dataset information of preclinical image datasets from any imaging modality associated to peer-review publications.
</h3>

<!-- ---------------- STAT CARDS ---------------- -->
<div class="pidar-stat-container mb-4">
    <div class="row g-4">

        <!-- Datasets -->
        <div class="col-md-4">
            <div class="pidar-stat-card pidar-green">
                <div class="pidar-icon" style="color: rgba(255,255,255,0.85); opacity: 1;">
                    <i class="fa-solid fa-database"></i>
                </div>
                <h3>@ViewData["DatasetCount"]</h3>
                <p>Datasets</p>
            </div>
        </div>

        <!-- Subjects -->
        <div class="col-md-4">
            <div class="pidar-stat-card pidar-white">
                <div class="pidar-icon" style="color: #444; opacity: 1;">
                    <i class="fa-solid fa-mouse"></i>
                </div>
                <h3 class="text-dark">@ViewData["TotalSampleSize"]</h3>
                <p class="text-dark">Total Subjects</p>
            </div>
        </div>

        <!-- Metadata Fields -->
        <div class="col-md-4">
            <div class="pidar-stat-card pidar-red">
                <div class="pidar-icon" style="color: rgba(255,255,255,0.85); opacity: 1;">
                    <i class="fa-solid fa-table-list"></i>
                </div>
                <h3>@ViewData["TableColumnCount"]</h3>
                <p>Metadata Fields</p>
            </div>
        </div>

    </div>
</div>




<!-- ---------------- SEARCH + CREATE ---------------- -->
<div class="row justify-content-between align-items-center mb-2">

    @if (SignInManager.IsSignedIn(User))
    {
        <!-- Left side (only when logged in) -->
        <div class="col-auto">
            <a class="btn btn-primary" href="/Datasets/Create">
                Create New Dataset
            </a>
        </div>
    }

    <!-- Right side (always visible, never stretched) -->
    <div class="col-auto ms-auto">
        <form method="get" class="form-inline" action="/Datasets/SearchResults">
            <input type="hidden" name="sortOrder" value="@ViewBag.CurrentSort" />
            <div class="input-group">
                <input name="SearchPhrase"
                       id="SearchPhrase"
                       class="form-control"
                       placeholder="Enter search phrase"
                       value="@Context.Request.Query["SearchPhrase"]" />
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>
    </div>

</div>



<!-- ---------------- TABLE ---------------- -->


<div class="table-responsive shadow-sm">
    <table class="table table-bordered table-striped text-center align-middle">
        <thead class="table-light">
            <tr>
                <th>
                    <a asp-action="Index" asp-route-sortOrder="@ViewData["DisplayIdSortParam"]">
                        Dataset ID
                        @if (ViewBag.CurrentSort == "displayid_desc")
                        {
                            <i class="fas fa-sort-down"></i>
                        }
                        else
                        {
                            <i class="fas fa-sort-up"></i>
                        }
                    </a>
                </th>

                <th>Imaging Modality</th>
                <th>Institution</th>
                <th>Facility</th>
                <th>Species</th>
                <th>Sample Size</th>
                <th>Disease Model</th>
                <th>Organ / Tissue</th>
                <th>License</th>
                <th>Status</th>
                <th>Year</th>

                @if (SignInManager.IsSignedIn(User))
                {
                    <th>Actions</th>
                }
            </tr>
        </thead>

        <tbody>
            @foreach (var ds in Model)
            {
                <tr>
                    <td>
                        <a asp-action="Details"
                           asp-route-displayId="@ds.DisplayId"
                           class="fw-bold text-primary text-decoration-none">
                            @ds.DisplayId
                        </a>
                    </td>

                    <!-- NESTED FROM CHILD TABLES -->
                    <td>@GetNestedSafe(ds, "StudyComponent.ImagingModality")</td>
                    <td>@GetNestedSafe(ds, "DatasetInfo.Institution")</td>
                    <td>@GetNestedSafe(ds, "DatasetInfo.ImagingFacility")</td>
                    <td>@GetNestedSafe(ds, "InVivo.Species")</td>
                    <td>@GetNestedSafe(ds, "InVivo.OverallSampleSize")</td>
                    <td>@GetNestedSafe(ds, "InVivo.DiseaseModel")</td>
                    <td>@GetNestedSafe(ds, "InVivo.OrganOrTissue")</td>
                    <td class="text-center">
                        @{
                            var license = GetNestedSafe(ds, "DatasetInfo.License")?.ToString()?.Trim();
                        }
                        @if (!string.IsNullOrWhiteSpace(license) &&
                                            license.Equals("CC BY", StringComparison.OrdinalIgnoreCase))
                        {
                            <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">
                                <img src="~/images/licenses/cc-by.png"
                                     class="license-logo"
                                     alt="CC BY 4.0"
                                     title="Creative Commons Attribution 4.0" />
                            </a>
                        }
                        else
                        {
                            @license
                        }
                    </td>

                    <td>@GetNestedSafe(ds, "Analyzed.Status")</td>
                    <td>@GetNestedSafe(ds, "Analyzed.UpdatedYear")</td>

                    @if (SignInManager.IsSignedIn(User))
                    {
                        <td>
                            <a asp-action="Edit" asp-route-id="@ds.DatasetId" class="me-2">Edit</a>
                            <a asp-action="Delete" asp-route-id="@ds.DatasetId" class="text-danger">Delete</a>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- ---------------- PAGINATION ---------------- -->
<div class="d-flex justify-content-center my-4">
    <nav>
        <ul class="pagination">

            @if (Model.HasPreviousPage)
            {
                <li class="page-item">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-pageNumber="@(Model.PageIndex - 1)"
                       asp-route-sortOrder="@ViewBag.CurrentSort">&laquo;</a>
                </li>
            }

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-pageNumber="@i"
                       asp-route-sortOrder="@ViewBag.CurrentSort">@i</a>
                </li>
            }

            @if (Model.HasNextPage)
            {
                <li class="page-item">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-pageNumber="@(Model.PageIndex + 1)"
                       asp-route-sortOrder="@ViewBag.CurrentSort">&raquo;</a>
                </li>
            }

        </ul>
    </nav>
</div>
