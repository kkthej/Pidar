@model Pidar.Models.ViewModels.DatasetCreateViewModel
@using Pidar.Helpers


@{
    ViewData["Title"] = "Create Dataset";

    var colorClasses = new[] { "primary", "success", "info", "warning", "danger", "secondary" };
    var colorIndex = 0;

    bool IsLong(string field)
    {
        return field.Contains("Background") ||
               field.Contains("Description") ||
               field.Contains("Procedure") ||
               field.Contains("Details") ||
               field.Contains("Protocol") ||
               field.Contains("Notes") ||
               field.Contains("Justification");
    }

    string PrettyLabel(string raw)
    {
        raw = raw.Replace("/", " ");

        string formatted = System.Text.RegularExpressions.Regex.Replace(
            raw,
            @"(?<=[a-z0-9])(?=[A-Z][a-z])",
            " "
        );

        return char.ToUpper(formatted[0]) + formatted.Substring(1);
    }

    // ------------ CATEGORY DEFINITIONS ------------
    var categories = CategoryProvider.GetCategories();
}

<h2 class="text-center mb-4">Create New Dataset</h2>

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()

    <!-- DISPLAY ID -->
    <div class="card mb-4 border-primary shadow-sm">
        <div class="card-header bg-primary text-white fw-bold">Basic Information</div>
        <div class="card-body">

            <div class="row mb-3">
                <div class="col-sm-4"><label class="form-label">Display Id</label></div>
                <div class="col-sm-8">
                    <input class="form-control" name="Dataset.DisplayId"
                           value="@Model.Dataset.DisplayId" />
                </div>
            </div>

        </div>
    </div>

    <!-- DYNAMIC CATEGORIES -->
    @foreach (var category in categories)
    {
        var color = colorClasses[colorIndex % colorClasses.Length];
        colorIndex++;

        <div class="card mb-4 shadow-sm border-@color">
            <div class="card-header bg-@color text-white fw-bold">@category.Key</div>
            <div class="card-body">

                @foreach (var field in category.Value)
                {
                    string label = field.Split('.')[1];
                    string pretty = PrettyLabel(label);
                    string? value = ObjectHelper.GetValue(Model, field);

                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <label class="form-label">@pretty</label>
                        </div>
                        <div class="col-sm-8">

                            @if (IsLong(label))
                            {
                                <textarea class="form-control"
                                          name="@field"
                                          rows="3">@value</textarea>
                            }
                            else
                            {
                                <input class="form-control"
                                       name="@field"
                                       value="@value" />
                            }

                        </div>
                    </div>
                }

            </div>
        </div>
    }

    <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary px-4">Create</button>
        <a asp-action="Index" class="btn btn-outline-secondary px-4">Cancel</a>
    </div>

</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
