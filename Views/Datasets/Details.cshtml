@model Pidar.Models.Dataset
@using Microsoft.AspNetCore.Html
@using Pidar.Areas.Identity.Data
@using Microsoft.AspNetCore.Identity
@using Pidar.Helpers
@inject SignInManager<PidarUser> SignInManager
@inject UserManager<PidarUser> UserManager
@inject ICategoryProvider CategoryProvider

@{
    ViewData["Title"] = "Dataset Details";
    var colorClasses = new[] { "primary", "success", "info", "warning", "danger", "secondary" };
    var colorIndex = 0;

    // ==========================================================
    // INLINE ONTOLOGY MAPPING (main field -> ontology field)
    // These ontology fields will be rendered as badges next to the main value
    // and the ontology row itself will be skipped to avoid duplicates.
    // ==========================================================
    var inlineOntologyMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        ["StudyComponent.ImagingModality"] = "Ontology.NcitImagingModality",
        ["StudyComponent.ImagingSubModality"] = "Ontology.NcitImagingSubmodality",
        ["StudyComponent.ImagingCoverage"] = "Ontology.UberonImagingCoverage",


        ["InVivo.DiseaseModel"] = "Ontology.DoidDiseaseModel",
        ["InVivo.OrganOrTissue"] = "Ontology.UberonOrganOrTissue",
        ["InVivo.StatisticalMethods"] = "Ontology.SwoStatisticalMethods",
        ["InVivo.Species"] = "Ontology.NcitSpecies",
        ["InVivo.Strain"] = "Ontology.EfoStrain",
        ["InVivo.ImmuneStatus"] = "Ontology.MpImmuneStatus",
        ["InVivo.Genotype"] = "Ontology.NcitGenotype",
        ["InVivo.GeneticManipulation"] = "Ontology.NcitGeneticManipulation",
        ["InVivo.Gene"] = "Ontology.GoGene",

        ["Procedures.PharmacologicalDrug"] = "Ontology.ChebiDrug",
        ["Procedures.TargetOrganTissue"] = "Ontology.ObiTargetOrganTissue",
        ["Procedures.AnalgesicName"] = "Ontology.ChebiAnalgesic",
        ["Procedures.AnesthesiaDrugs"] = "Ontology.ChebiAnestetic",
        ["Procedures.Method"] = "Ontology.ObiEuthanasiaMethod",
        ["Procedures.TissuesCollectedPostEuthanasia"] = "Ontology.UberonTissueExcised",
        ["Procedures.TissueDescription"] = "Ontology.MpathHistologicalTissueDescription",
        ["Procedures.ContrastAgentChemicalDrug"] = "Ontology.ChebiContrastAgent",
        ["Procedures.RouteOfAdministration"] = "Ontology.ObiRouteAdministration",
        ["Procedures.CellLine"] = "Ontology.ClCellLineName"

    };

    var ontologyPathsToSkip = new HashSet<string>(inlineOntologyMap.Values, StringComparer.OrdinalIgnoreCase);
}

@functions {

    /* ==========================================================
       CHECK IF VALUE IS MEANINGFUL
       ========================================================== */
    public static bool IsMeaningful(object? value)
    {
        if (value == null) return false;

        var str = value.ToString()?.Trim().ToLower();
        if (string.IsNullOrWhiteSpace(str)) return false;

        var hiddenValues = new[]
        {
            "n/a", "na", "none", "not available", "null", "-", "unknown",
            "not applicable", "pending", "todo"
        };

        return !hiddenValues.Contains(str);
    }

    /* ==========================================================
       FORMAT LABEL (camelCase → spaced words, keep acronyms)
       ========================================================== */
    public IHtmlContent FormatLabel(string raw)
    {
        if (String.IsNullOrWhiteSpace(raw))
            return HtmlString.Empty;

        // Normalize
        var clean = raw.Replace("/", " ");

        // Insert space before camelCase boundaries
        var spaced = System.Text.RegularExpressions.Regex.Replace(
            clean,
            @"(?<=[a-z0-9])(?=[A-Z])",
            " "
        );

        var parts = spaced.Split(' ', StringSplitOptions.RemoveEmptyEntries).ToList();

        // Known acronyms to auto-upcase
        var acronyms = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "ncit", "doid", "chebi", "clo", "ror", "pi", "qa", "qc", "duo", "doi", "orcid"
        };

        // Format each token
        for (int i = 0; i < parts.Count; i++)
        {
            var p = parts[i];

            // Pure acronym (QA, QC, PI, ROR, NCIT…)
            if (acronyms.Contains(p.ToLower()))
            {
                parts[i] = p.ToUpper();
                continue;
            }

            // Prefix acronym (RorCodeOwner → ROR CodeOwner)
            foreach (var ac in acronyms)
            {
                if (p.StartsWith(ac, StringComparison.OrdinalIgnoreCase))
                {
                    var suffix = p.Substring(ac.Length);
                    parts[i] = ac.ToUpper() +
                               (suffix.Length > 0 ? " " + suffix : "");
                    break;
                }
            }

            // Normal word → Title Case
            if (!parts[i].All(Char.IsUpper))
            {
                parts[i] = Char.ToUpper(parts[i][0]) + parts[i].Substring(1);
            }
        }

        var finalLabel = String.Join(" ", parts).Trim();

        /* ============================================================
           SPECIAL CASE RULES
           ============================================================ */

        // QA QC → QA/QC
        if (finalLabel.Equals("QA QC", StringComparison.OrdinalIgnoreCase))
            finalLabel = "QA/QC";

        // QA QC Info → QA/QC Info
        if (finalLabel.Equals("QA QC Info", StringComparison.OrdinalIgnoreCase))
            finalLabel = "QA/QC Info";

        // RorCodeOwner → ROR Code Owner
        if (finalLabel.Equals("Ror Code Owner", StringComparison.OrdinalIgnoreCase))
            finalLabel = "ROR Code Owner";

        // PiOrchid → PI-ORCID
        // Your property is "PiOrchid" but the correct acronym is ORCID, not Orchid
        if (finalLabel.Equals("Pi Orchid", StringComparison.OrdinalIgnoreCase))
            finalLabel = "PI-ORCID";

        return new HtmlString(System.Net.WebUtility.HtmlEncode(finalLabel));
    }

    /* ==========================================================
       UNIVERSAL VALUE FORMATTER
       ========================================================== */
    public IHtmlContent FormatValue(object? value)
    {
        var str = value?.ToString()?.Trim();
        if (String.IsNullOrWhiteSpace(str))
            return HtmlString.Empty;

        if (Uri.TryCreate(str, UriKind.Absolute, out var uri))
        {
            if (uri.Scheme == Uri.UriSchemeMailto || str.Contains("@"))
                return new HtmlString($"<a href=\"mailto:{str}\">{str}</a>");

            return new HtmlString($"<a href=\"{str}\" target=\"_blank\">{str}</a>");
        }

        if (str.Contains("@") && str.Contains("."))
            return new HtmlString($"<a href=\"mailto:{str}\">{str}</a>");

        str = str.Replace("/", " ");
        var formatted = System.Text.RegularExpressions.Regex.Replace(
            str,
            @"(?<=[a-z0-9])(?=[A-Z][a-z])",
            " "
        ).Trim();

        if (formatted.Length > 0)
            formatted = Char.ToUpper(formatted[0]) + formatted[1..];

        return new HtmlString(System.Net.WebUtility.HtmlEncode(formatted));
    }

    public IHtmlContent RenderLicense(object? value)
    {
        var str = value?.ToString()?.Trim();
        if (string.IsNullOrWhiteSpace(str))
            return HtmlString.Empty;

        if (str.Equals("CC BY", StringComparison.OrdinalIgnoreCase))
        {
            return new HtmlString(
                "<a href=\"https://creativecommons.org/licenses/by/4.0/\" target=\"_blank\" rel=\"noopener\">" +
                "<img class=\"license-logo\" src=\"/images/licenses/cc-by.png\" alt=\"CC BY 4.0\" title=\"Creative Commons Attribution 4.0\" />" +
                "</a>"
            );
        }
        else if (str.Equals("CC BY NC", StringComparison.OrdinalIgnoreCase))
        {
            return new HtmlString(
                "<a href=\"https://creativecommons.org/licenses/by/4.0/\" target=\"_blank\" rel=\"noopener\">" +
                "<img class=\"license-logo\" src=\"/images/licenses/cc-by-nc.png\" alt=\"CC BY NC 4.0\" title=\"Creative Commons Attribution 4.0\" />" +
                "</a>"
            );
        }
        else if (str.Equals("CC BY NC ND", StringComparison.OrdinalIgnoreCase))
        {
            return new HtmlString(
                "<a href=\"https://creativecommons.org/licenses/by/4.0/\" target=\"_blank\" rel=\"noopener\">" +
                "<img class=\"license-logo\" src=\"/images/licenses/cc-by-nc-nd.png\" alt=\"CC BY NC 4.0\" title=\"Creative Commons Attribution 4.0\" />" +
                "</a>"
            );
        }

        return new HtmlString(System.Net.WebUtility.HtmlEncode(str));
    }

    /* ==========================================================
       UNIVERSAL NULL-SAFE NESTED ACCESSOR  (A.B.C)
       ========================================================== */
    public object? GetNested(object? root, string path)
    {
        if (root == null || String.IsNullOrWhiteSpace(path))
            return null;

        object? current = root;
        foreach (var part in path.Split('.'))
        {
            if (current == null) return null;
            var prop = current.GetType().GetProperty(part);
            if (prop == null) return null;

            current = prop.GetValue(current);
        }
        return current;
    }
}

<!-- HEADER -->
<div>
    <h3 class="text-center mb-4"><strong>Dataset ID:</strong> @Model.DisplayId</h3>

    <div>
        @if (SignInManager.IsSignedIn(User))
        {
            <a asp-action="Edit" class="btn btn-outline-success" asp-route-id="@Model.DatasetId">Edit</a>
        }
        <a asp-action="Index" class="btn btn-outline-secondary">Back to List</a>
        
    </div>
</div>

<hr />

@{
    var categories = CategoryProvider.GetCategories();
}

<div class="container my-4">
    <h2 class="text-center mb-4">Dataset Details</h2>

    @foreach (var category in categories)
    {
        bool hasContent = category.Value.Any(path =>
        {
            var val = GetNested(Model, path);
            return IsMeaningful(val);
        });

        if (!hasContent)
            continue;

        var color = colorClasses[colorIndex % colorClasses.Length];
        colorIndex++;

        <div class="card mb-4 shadow-sm border-@color">
            <div class="card-header bg-@color text-white text-center fw-bold">
                @category.Key
            </div>

            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <colgroup>
                        <col style="width:30%">
                        <col style="width:70%">
                    </colgroup>

                    <tbody>
                        @foreach (var path in category.Value)
                        {
                            // 1) Skip ontology rows that are rendered inline
                            if (ontologyPathsToSkip.Contains(path))
                                continue;

                            var value = GetNested(Model, path);

                            if (!IsMeaningful(value))
                                continue;

                            // 2) If this path has a paired ontology code, fetch it
                            object? inlineOntologyValue = null;
                            if (inlineOntologyMap.TryGetValue(path, out var ontologyPath))
                            {
                                inlineOntologyValue = GetNested(Model, ontologyPath);
                                if (!IsMeaningful(inlineOntologyValue))
                                    inlineOntologyValue = null;
                            }

                            <tr>
                                <th class="bg-light text-center pe-3 align-middle">
                                    @FormatLabel(path.Split('.').Last())
                                </th>

                                <td class="align-middle">
                                    <div class="value-with-onto">
                                        <div class="value-main">
                                            @{
                                                var fieldName = path.Split('.').Last();

                                                if (path.StartsWith("Ontology.", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <span class="ontology-link">
                                                        @Html.Raw(AutoOntologyRenderer.Render(value?.ToString()))
                                                    </span>
                                                }
                                                else if (fieldName.Equals("License", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    @RenderLicense(value)
                                                }
                                                else
                                                {
                                                    @FormatValue(value)
                                                }
                                            }
                                        </div>

                                        @if (inlineOntologyValue != null)
                                        {
                                            var ontoText = inlineOntologyValue.ToString()?.Trim();
                                            if (!string.IsNullOrWhiteSpace(ontoText))
                                            {
                                                <div class="value-onto ontology-link">
                                                    @Html.Raw(AutoOntologyRenderer.Render(ontoText))
                                                </div>
                                            }
                                        }
                                    </div>
                                </td>

                            </tr>
                        }

                    </tbody>

                </table>
            </div>
        </div>
    }
</div>

<!-- FOOTER -->
<div class="mb-4">
    @if (SignInManager.IsSignedIn(User))
    {
        <a asp-action="Edit" asp-route-id="@Model.DatasetId">Edit</a>
    }
    <a asp-action="Index">Back to List</a>
</div>
