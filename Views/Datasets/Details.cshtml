@model Pidar.Models.Dataset
@using Microsoft.AspNetCore.Html
@using Pidar.Areas.Identity.Data
@using Microsoft.AspNetCore.Identity
@using Pidar.Helpers <!-- REQUIRED FOR AUTO ONTOLOGY RENDERING -->
@inject SignInManager<PidarUser> SignInManager
@inject UserManager<PidarUser> UserManager
@inject ICategoryProvider CategoryProvider

@{
    ViewData["Title"] = "Dataset Details";
    var colorClasses = new[] { "primary", "success", "info", "warning", "danger", "secondary" };
    var colorIndex = 0;
}

@functions {

    /* ==========================================================
       CHECK IF VALUE IS MEANINGFUL
       ========================================================== */
    public static bool IsMeaningful(object? value)
    {
        if (value == null) return false;

        var str = value.ToString()?.Trim().ToLower();
        if (string.IsNullOrWhiteSpace(str)) return false;

        var hiddenValues = new[]
        {
            "n/a", "na", "none", "not available", "null", "-", "unknown",
            "not applicable", "pending", "todo"
        };

        return !hiddenValues.Contains(str);
    }

    /* ==========================================================
       FORMAT LABEL (camelCase → spaced words, keep acronyms)
       ========================================================== */
    public IHtmlContent FormatLabel(string raw)
    {
        if (String.IsNullOrWhiteSpace(raw))
            return HtmlString.Empty;

        // Normalize
        var clean = raw.Replace("/", " ");

        // Insert space before camelCase boundaries
        var spaced = System.Text.RegularExpressions.Regex.Replace(
            clean,
            @"(?<=[a-z0-9])(?=[A-Z])",
            " "
        );

        var parts = spaced.Split(' ', StringSplitOptions.RemoveEmptyEntries).ToList();

        // Known acronyms to auto-upcase
        var acronyms = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
    {
        "ncit", "doid", "chebi", "clo", "ror", "pi", "qa", "qc", "duo", "doi", "orcid"
    };

        // Format each token
        for (int i = 0; i < parts.Count; i++)
        {
            var p = parts[i];

            // Pure acronym (QA, QC, PI, ROR, NCIT…)
            if (acronyms.Contains(p.ToLower()))
            {
                parts[i] = p.ToUpper();
                continue;
            }

            // Prefix acronym (RorCodeOwner → ROR CodeOwner)
            foreach (var ac in acronyms)
            {
                if (p.StartsWith(ac, StringComparison.OrdinalIgnoreCase))
                {
                    var suffix = p.Substring(ac.Length);
                    parts[i] = ac.ToUpper() +
                               (suffix.Length > 0 ? " " + suffix : "");
                    break;
                }
            }

            // Normal word → Title Case
            if (!parts[i].All(Char.IsUpper))
            {
                parts[i] = Char.ToUpper(parts[i][0]) + parts[i].Substring(1);
            }
        }

        var finalLabel = String.Join(" ", parts).Trim();

        /* ============================================================
           SPECIAL CASE RULES
           ============================================================ */

        // QA QC → QA/QC
        if (finalLabel.Equals("QA QC", StringComparison.OrdinalIgnoreCase))
            finalLabel = "QA/QC";

        // QA QC Info → QA/QC Info
        if (finalLabel.Equals("QA QC Info", StringComparison.OrdinalIgnoreCase))
            finalLabel = "QA/QC Info";

        // RorCodeOwner → ROR Code Owner
        if (finalLabel.Equals("Ror Code Owner", StringComparison.OrdinalIgnoreCase))
            finalLabel = "ROR Code Owner";

        // PiOrchid → PI-ORCID
        // Your property is "PiOrchid" but the correct acronym is ORCID, not Orchid
        if (finalLabel.Equals("Pi Orchid", StringComparison.OrdinalIgnoreCase))
            finalLabel = "PI-ORCID";

        return new HtmlString(System.Net.WebUtility.HtmlEncode(finalLabel));
    }


    /* ==========================================================
       UNIVERSAL VALUE FORMATTER
       ========================================================== */
    public IHtmlContent FormatValue(object? value)
    {
        var str = value?.ToString()?.Trim();
        if (String.IsNullOrWhiteSpace(str))
            return HtmlString.Empty;

        if (Uri.TryCreate(str, UriKind.Absolute, out var uri))
        {
            if (uri.Scheme == Uri.UriSchemeMailto || str.Contains("@"))
                return new HtmlString($"<a href=\"mailto:{str}\">{str}</a>");

            return new HtmlString($"<a href=\"{str}\" target=\"_blank\">{str}</a>");
        }

        if (str.Contains("@") && str.Contains("."))
            return new HtmlString($"<a href=\"mailto:{str}\">{str}</a>");

        str = str.Replace("/", " ");
        var formatted = System.Text.RegularExpressions.Regex.Replace(
            str,
            @"(?<=[a-z0-9])(?=[A-Z][a-z])",
            " "
        ).Trim();

        if (formatted.Length > 0)
            formatted = Char.ToUpper(formatted[0]) + formatted[1..];

        return new HtmlString(System.Net.WebUtility.HtmlEncode(formatted));
    }

    public IHtmlContent RenderLicense(object? value)
    {
        var str = value?.ToString()?.Trim();
        if (string.IsNullOrWhiteSpace(str))
            return HtmlString.Empty;

        if (str.Equals("CC BY", StringComparison.OrdinalIgnoreCase))
        {
            return new HtmlString(
                "<a href=\"https://creativecommons.org/licenses/by/4.0/\" target=\"_blank\" rel=\"noopener\">" +
                "<img class=\"license-logo\" src=\"/images/licenses/cc-by.png\" alt=\"CC BY 4.0\" title=\"Creative Commons Attribution 4.0\" />" +
                "</a>"
            );
        }else if (str.Equals("CC BY NC", StringComparison.OrdinalIgnoreCase))
        {
            return new HtmlString(
                "<a href=\"https://creativecommons.org/licenses/by/4.0/\" target=\"_blank\" rel=\"noopener\">" +
                "<img class=\"license-logo\" src=\"/images/licenses/cc-by-nc.png\" alt=\"CC BY NC 4.0\" title=\"Creative Commons Attribution 4.0\" />" +
                "</a>"
            );
        }
        else if (str.Equals("CC BY NC ND", StringComparison.OrdinalIgnoreCase))
        {
            return new HtmlString(
                "<a href=\"https://creativecommons.org/licenses/by/4.0/\" target=\"_blank\" rel=\"noopener\">" +
                "<img class=\"license-logo\" src=\"/images/licenses/cc-by-nc-nd.png\" alt=\"CC BY NC 4.0\" title=\"Creative Commons Attribution 4.0\" />" +
                "</a>"
            );
        }

        return new HtmlString(System.Net.WebUtility.HtmlEncode(str));
    }




    /* ==========================================================
       UNIVERSAL NULL-SAFE NESTED ACCESSOR  (A.B.C)
       ========================================================== */
    public object? GetNested(object? root, string path)
    {
        if (root == null || String.IsNullOrWhiteSpace(path))
            return null;

        object? current = root;
        foreach (var part in path.Split('.'))
        {
            if (current == null) return null;
            var prop = current.GetType().GetProperty(part);
            if (prop == null) return null;

            current = prop.GetValue(current);
        }
        return current;
    }
}

<!-- HEADER -->
<div>
    <strong>Dataset ID:</strong> @Model.DisplayId

    <div>
        @if (SignInManager.IsSignedIn(User))
        {
            <a asp-action="Edit" asp-route-id="@Model.DatasetId">Edit</a>
        }
        <a asp-action="Index">Back to List</a>
    </div>
</div>

<hr />

@{
    var categories = CategoryProvider.GetCategories();
}

<div class="container my-4">
    <h2 class="text-center mb-4">Dataset Details</h2>

    @foreach (var category in categories)
    {
        /* ===================================================================
        UPDATE: category visibility now checks IsMeaningful() instead of
        only null/empty → N/A fields no longer trigger category display
        =================================================================== */
        bool hasContent = category.Value.Any(path =>
        {
            var val = GetNested(Model, path);
            return IsMeaningful(val);
        });

        if (!hasContent)
            continue;

        var color = colorClasses[colorIndex % colorClasses.Length];
        colorIndex++;

        <div class="card mb-4 shadow-sm border-@color">
            <div class="card-header bg-@color text-white text-center fw-bold">
                @category.Key
            </div>

            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <colgroup>
                        <col style="width:30%">
                        <col style="width:70%">
                    </colgroup>

                    <tbody>
                        @foreach (var path in category.Value)
                        {
                            var value = GetNested(Model, path);

                            /* ============================================
                            UPDATE: field-level filtering using IsMeaningful
                            ============================================ */
                            if (!IsMeaningful(value))
                                continue;

                            <tr>
                                <th class="bg-light text-center pe-3 align-middle">
                                    @FormatLabel(path.Split('.').Last())
                                </th>

                                <td>
                                    @{
                                        var fieldName = path.Split('.').Last();

                                        if (path.StartsWith("Ontology.", StringComparison.OrdinalIgnoreCase))
                                        {
                                            @Html.Raw(AutoOntologyRenderer.Render(value?.ToString()))
                                        }
                                        else if (fieldName.Equals("License", StringComparison.OrdinalIgnoreCase))
                                        {
                                            @RenderLicense(value)
                                        }
                                        else
                                        {
                                            @FormatValue(value)
                                        }
                                    }


                                </td>
                            </tr>
                        }
                    </tbody>

                </table>
            </div>
        </div>
    }
</div>

<!-- FOOTER -->
<div class="mb-4">
    @if (SignInManager.IsSignedIn(User))
    {
        <a asp-action="Edit" asp-route-id="@Model.DatasetId">Edit</a>
    }
    <a asp-action="Index">Back to List</a>
</div>
