@model Pidar.Models.Dataset
@using Microsoft.AspNetCore.Html
@using Pidar.Areas.Identity.Data
@using Microsoft.AspNetCore.Identity
@using Pidar.Helpers   <!-- REQUIRED FOR AUTO ONTOLOGY RENDERING -->
@inject SignInManager<PidarUser> SignInManager
@inject UserManager<PidarUser> UserManager
@inject ICategoryProvider CategoryProvider

@{
    ViewData["Title"] = "Details";
    var colorClasses = new[] { "primary", "success", "info", "warning", "danger", "secondary" };
    var colorIndex = 0;
}

@functions {

    /* ==========================================================
       FORMAT LABEL (camelCase → spaced words, keep acronyms)
       ========================================================== */
    public IHtmlContent FormatLabel(string raw)
    {
        if (String.IsNullOrWhiteSpace(raw))
            return HtmlString.Empty;

        var clean = raw.Replace("/", " ");
        var formatted = System.Text.RegularExpressions.Regex.Replace(
            clean,
            @"(?<=[a-z0-9])(?=[A-Z][a-z])",
            " "
        ).Trim();

        if (formatted.Length > 0)
            formatted = Char.ToUpper(formatted[0]) + formatted[1..];

        return new HtmlString(System.Net.WebUtility.HtmlEncode(formatted));
    }

    /* ==========================================================
       UNIVERSAL FALLBACK FORMATTER (non-ontology)
       ========================================================== */
    public IHtmlContent FormatValue(object? value)
    {
        var str = value?.ToString()?.Trim();
        if (String.IsNullOrWhiteSpace(str))
            return HtmlString.Empty;

        // URL or mailto
        if (Uri.TryCreate(str, UriKind.Absolute, out var uri))
        {
            if (uri.Scheme == Uri.UriSchemeMailto || str.Contains("@"))
                return new HtmlString($"<a href=\"mailto:{str}\">{str}</a>");

            return new HtmlString($"<a href=\"{str}\" target=\"_blank\">{str}</a>");
        }

        // Email-like
        if (str.Contains("@") && str.Contains("."))
            return new HtmlString($"<a href=\"mailto:{str}\">{str}</a>");

        // Normal formatting
        str = str.Replace("/", " ");
        var formatted = System.Text.RegularExpressions.Regex.Replace(
            str,
            @"(?<=[a-z0-9])(?=[A-Z][a-z])",
            " "
        ).Trim();

        if (formatted.Length > 0)
            formatted = Char.ToUpper(formatted[0]) + formatted[1..];

        return new HtmlString(System.Net.WebUtility.HtmlEncode(formatted));
    }

    /* ==========================================================
       UNIVERSAL NULL-SAFE NESTED ACCESSOR  (A.B.C)
       ========================================================== */
    public object? GetNested(object? root, string path)
    {
        if (root == null || String.IsNullOrWhiteSpace(path))
            return null;

        object? current = root;
        foreach (var part in path.Split('.'))
        {
            if (current == null) return null;
            var prop = current.GetType().GetProperty(part);
            if (prop == null) return null;
            current = prop.GetValue(current);
        }
        return current;
    }
}

<!-- HEADER -->
<div>
    <strong>Dataset ID:</strong> @Model.DisplayId

    <div>
        @if (SignInManager.IsSignedIn(User))
        {
            <a asp-action="Edit" asp-route-id="@Model.DatasetId">Edit</a>
        }
        <a asp-action="Index">Back to List</a>
    </div>
</div>

<hr />

<!-- CATEGORY DEFINITIONS -->
@{
    var categories = CategoryProvider.GetCategories();
}

<!-- ==========================
     RENDER DETAILS UI
     ========================== -->
<div class="container my-4">
    <h2 class="text-center mb-4">Dataset Details</h2>

    @foreach (var category in categories)
    {
        bool hasContent = category.Value.Any(path =>
        {
            var val = GetNested(Model, path);
            return val != null && !String.IsNullOrWhiteSpace(val.ToString());
        });

        if (!hasContent)
            continue;

        var color = colorClasses[colorIndex % colorClasses.Length];
        colorIndex++;

        <div class="card mb-4 shadow-sm border-@color">
            <div class="card-header bg-@color text-white text-center fw-bold">
                @category.Key
            </div>

            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <colgroup>
                        <col style="width:30%">
                        <col style="width:70%">
                    </colgroup>
                    <tbody>
                        @foreach (var path in category.Value)
                        {
                            var value = GetNested(Model, path);
                            if (value == null || String.IsNullOrWhiteSpace(value.ToString()))
                                continue;

                            <tr>
                                <th class="bg-light text-center pe-3 align-middle">
                                    @FormatLabel(path.Split('.').Last())
                                </th>

                                <td>
                                    @{
                                        /* ================================
                                           AUTOMATIC ONTOLOGY DETECTION
                                           If a field starts with "Ontology."
                                           → render clickable ontology badges
                                           ================================ */
                                        if (path.StartsWith("Ontology.", StringComparison.OrdinalIgnoreCase))
                                        {
                                            @Html.Raw(AutoOntologyRenderer.Render(value.ToString()))
                                        }
                                        else
                                        {
                                            @FormatValue(value)
                                        }
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<!-- FOOTER -->
<div class="mb-4">
    @if (SignInManager.IsSignedIn(User))
    {
        <a asp-action="Edit" asp-route-id="@Model.DatasetId">Edit</a>
    }
    <a asp-action="Index">Back to List</a>
</div>
